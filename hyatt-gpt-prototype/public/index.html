<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyatt GPT Agents System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000000;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            padding-top: 90px; /* Reduced space for smaller header */
        }

        /* Fixed full-width header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f8f9fa;
            color: #2c3e50;
            padding: 15px 30px;
            text-align: left;
            z-index: 1003;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e9ecef;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.8;
            margin: 0;
            color: #495057;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: margin-left 0.3s ease, margin-right 0.3s ease;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .container.progress-open {
            margin-left: 400px;
        }

        .container.deliverables-open {
            margin-right: 400px;
        }

        .container.both-open {
            margin-left: 400px;
            margin-right: 400px;
        }

        .main-content {
            padding: 30px;
        }

        .campaign-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-section {
            margin-top: 30px;
        }

        .status-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .status-card.active {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .status-card.completed {
            border-color: #28a745;
            background: #f8fff9;
        }

        .phase-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .phase-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            color: white;
        }

        .phase-icon.research { background: #3498db; }
        .phase-icon.trending { background: #e74c3c; }
        .phase-icon.story { background: #f39c12; }
        .phase-icon.collaborative { background: #9b59b6; }

        .phase-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .phase-status {
            margin-left: auto;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .status-active {
            background: #74b9ff;
            color: white;
        }

        .status-completed {
            background: #00b894;
            color: white;
        }

        .results-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .campaigns-list {
            margin-top: 30px;
        }

        .campaigns-list h2 {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: background-color 0.3s ease;
        }

        .campaigns-list h2:hover {
            background: #e9ecef;
        }

        .campaigns-toggle {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .campaigns-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            max-height: 0;
        }

        .campaigns-content.open {
            max-height: 1000px;
        }

        .campaign-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .campaign-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .campaign-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .campaign-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .campaign-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .conversation-flow {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .conversation-messages {
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .conversation-message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }

        .conversation-message.pr-manager {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .conversation-message.campaign-brief {
            background: #f3e5f5;
            border-left-color: #9c27b0;
            border: 2px solid #9c27b0;
            font-weight: 500;
        }

        .conversation-message.research-agent {
            background: #f3e5f5;
            border-left-color: #9c27b0;
        }

        .conversation-message.strategic-agent {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .conversation-message.trending-agent {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .conversation-message.story-agent {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }

        .conversation-message.all-agents {
            background: #fce4ec;
            border-left-color: #e91e63;
        }

        .conversation-message.processing {
            background: #f5f5f5;
            border-left-color: #9e9e9e;
            font-style: italic;
        }

        .message-speaker {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .message-content {
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .message-deliverable {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
        }

        .deliverable-title {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 8px;
        }

        .message-timestamp {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
        }

        #newMessagesIndicator {
            display: block;
            margin-top: 10px;
            margin-left: auto;
            margin-right: auto;
            padding: 10px 20px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }

        #newMessagesIndicator:hover {
            background-color: #e68a00;
        }

        /* Side Panel for Progress Updates - LEFT SIDE */
        .progress-panel {
            position: fixed;
            left: -400px;
            top: 90px; /* Start below smaller header */
            width: 400px;
            height: calc(100vh - 90px); /* Full height minus smaller header */
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
            border-right: 1px solid #e9ecef;
        }

        .progress-panel.open {
            left: 0;
        }

        /* Side Panel for Deliverables - RIGHT SIDE */
        .deliverables-panel {
            position: fixed;
            right: 0;
            top: 90px; /* Start below smaller header */
            width: 400px;
            height: calc(100vh - 90px); /* Full height minus smaller header */
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow-y: auto;
            border-left: 1px solid #e9ecef;
        }

        .panel-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            z-index: 1002;
        }

        .panel-header h3 {
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }

        .deliverables-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            z-index: 1001;
        }

        .deliverables-header h3 {
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }

        .close-panel {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .deliverables-content {
            padding: 20px;
        }

        .progress-content {
            padding: 15px;
            background: #f8f9fa;
        }

        .deliverable-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .deliverable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .deliverable-header:hover {
            background: #e9ecef;
        }

        .deliverable-header.expanded {
            background: #e3f2fd;
        }

        .deliverable-header h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1.1rem;
        }

        .agent-name {
            color: #666;
            font-size: 0.9rem;
        }

        .deliverable-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .download-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .download-btn:hover {
            background: #0056b3;
        }

        .collapse-icon {
            font-size: 1.2rem;
            color: #666;
            transition: transform 0.3s ease;
        }

        .collapse-icon.expanded {
            transform: rotate(180deg);
        }

        .deliverable-content {
            padding: 15px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: none;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .deliverable-content.expanded {
            display: block;
        }

        /* Markdown styling for deliverables - smaller fonts */
        .deliverable-content h1,
        .deliverable-content h2,
        .deliverable-content h3,
        .deliverable-content h4,
        .deliverable-content h5,
        .deliverable-content h6 {
            color: #2c3e50;
            margin: 12px 0 6px 0;
            font-weight: 600;
        }

        .deliverable-content h1 { font-size: 1.2rem; border-bottom: 2px solid #3498db; padding-bottom: 3px; }
        .deliverable-content h2 { font-size: 1.1rem; border-bottom: 1px solid #bdc3c7; padding-bottom: 2px; }
        .deliverable-content h3 { font-size: 1.0rem; color: #34495e; }
        .deliverable-content h4 { font-size: 0.9rem; color: #7f8c8d; }

        .deliverable-content p {
            margin: 6px 0;
            line-height: 1.4;
            font-size: 0.8rem;
        }

        .deliverable-content ul,
        .deliverable-content ol {
            margin: 6px 0 6px 12px;
            padding-left: 12px;
        }

        .deliverable-content li {
            margin: 3px 0;
            line-height: 1.3;
            font-size: 0.8rem;
        }

        .deliverable-content strong,
        .deliverable-content b {
            color: #2c3e50;
            font-weight: 600;
        }

        .deliverable-content em,
        .deliverable-content i {
            color: #7f8c8d;
            font-style: italic;
        }

        .deliverable-content code {
            background: #f8f9fa;
            padding: 1px 4px;
            border-radius: 2px;
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            color: #e74c3c;
        }

        .deliverable-content blockquote {
            border-left: 3px solid #3498db;
            margin: 10px 0;
            padding: 6px 10px;
            background: #f8f9fa;
            font-style: italic;
            color: #555;
            font-size: 0.8rem;
        }

        /* Progress Updates Section - now for side panel */
        .progress-updates {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .progress-header {
            background: #495057;
            color: white;
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 8px 8px 0 0;
        }

        .progress-messages {
            padding: 12px;
            background: #ffffff;
        }

        .progress-message {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            margin: 3px 0;
            padding: 6px 10px;
            border-radius: 4px;
            line-height: 1.4;
            border-left: 3px solid;
        }

        .progress-message.info {
            color: #1a365d;
            background: #e6f3ff;
            border-left-color: #3182ce;
        }

        .progress-message.success {
            color: #1a202c;
            background: #d4edda;
            border-left-color: #38a169;
        }

        .progress-message.warning {
            color: #744210;
            background: #fff3cd;
            border-left-color: #d69e2e;
        }

        .progress-message.error {
            color: #742a2a;
            background: #fed7d7;
            border-left-color: #e53e3e;
        }

        .progress-message.phase {
            color: #44337a;
            background: #e9d8fd;
            border-left-color: #805ad5;
            font-weight: 600;
        }

        .progress-timestamp {
            color: #4a5568;
            font-size: 0.7rem;
            margin-right: 8px;
            font-weight: 500;
        }

        .deliverable-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .deliverable-toggle:hover {
            background: #5a6fd8;
        }

        .deliverable-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        /* Overlay for mobile */
        .panel-overlay {
            position: fixed;
            top: 120px; /* Start below fixed header */
            left: 0;
            width: 100%;
            height: calc(100vh - 120px); /* Full height minus header */
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .panel-overlay.show {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding-top: 140px; /* More space for header on mobile */
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .deliverables-panel {
                width: 100%;
                right: -100%;
                top: 140px; /* Account for mobile header height */
                height: calc(100vh - 140px);
            }
            
            .progress-panel {
                width: 100%;
                left: -100%;
                top: 140px; /* Account for mobile header height */
                height: calc(100vh - 140px);
            }
            
            .deliverables-panel.open {
                right: 0;
            }
            
            .progress-panel.open {
                left: 0;
            }
            
            .container.progress-open,
            .container.deliverables-open,
            .container.both-open {
                margin-left: 20px;
                margin-right: 20px;
            }
            
            /* Show overlay on mobile only */
            .panel-overlay {
                display: none;
                top: 140px; /* Start below header */
                height: calc(100vh - 140px);
            }
            
            .panel-overlay.show {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏨 Hyatt GPT Agents System</h1>
            <p>Collaborative AI agents for PR campaign development</p>
        </div>

        <div class="main-content">
            <div class="campaign-form">
                <h2 style="font-size: 1.4rem;">Create New Campaign</h2>
                <div class="form-group">
                    <label for="campaignBrief">Campaign Brief</label>
                    <textarea 
                        id="campaignBrief" 
                        name="campaignBrief" 
                        placeholder="Describe your campaign requirements. For example: 'We're launching a new property next quarter. Please describe the property type, target audience, key features, and campaign objectives for a comprehensive PR strategy.'"
                        required>
                    </textarea>
                </div>
                <button class="btn" onclick="createCampaign()" id="createBtn">
                    Create Campaign
                </button>
            </div>

            <div id="statusSection" class="status-section" style="display: none;">
                <h2>Campaign Progress</h2>
                <div id="campaignId">
                    <div class="campaign-id">No active campaign</div>
                </div>
                <button id="progressBtn" onclick="openProgressPanel()" style="display: none; background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 20px; margin-top: 10px; cursor: pointer;">
                    View Progress
                </button>
                
                <button id="deliverablesBtn" onclick="openDeliverablesPanel()" style="display: none; background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 20px; margin-top: 10px; margin-left: 10px; cursor: pointer;">
                    View Deliverables
                </button>
                
                <!-- Progress Updates Section (Hidden - now in side panel) -->
                <div id="progressUpdates" class="progress-updates" style="display: none;">
                    <div class="progress-header">
                        🔄 Campaign Progress Updates
                    </div>
                    <div class="progress-messages" id="progressMessages">
                        <!-- Progress messages will be added here -->
                    </div>
                </div>
                
                <!-- Conversation Flow Display -->
                <div id="conversationFlow" class="conversation-flow">
                    <h3>Agent Collaboration</h3>
                    <div id="conversationMessages" class="conversation-messages"></div>
                    <button id="newMessagesIndicator" style="display: none;" onclick="scrollToConversationBottom()">
                        ↓ New Messages Below ↓
                    </button>
                </div>

                <!-- Traditional Phase Cards (Hidden by default) -->
                <div id="phaseCards" style="display: none;">
                    <div class="status-card" id="researchCard">
                        <div class="phase-header">
                            <div class="phase-icon research">1</div>
                            <div class="phase-title">Research & Audience Analysis</div>
                            <div class="phase-status status-pending" id="researchStatus">Pending</div>
                        </div>
                        <div id="researchResults" class="results-section" style="display: none;"></div>
                    </div>

                    <div class="status-card" id="trendingCard">
                        <div class="phase-header">
                            <div class="phase-icon trending">2</div>
                            <div class="phase-title">Trending News Analysis</div>
                            <div class="phase-status status-pending" id="trendingStatus">Pending</div>
                        </div>
                        <div id="trendingResults" class="results-section" style="display: none;"></div>
                    </div>

                    <div class="status-card" id="storyCard">
                        <div class="phase-header">
                            <div class="phase-icon story">3</div>
                            <div class="phase-title">Story Angles & Headlines</div>
                            <div class="phase-status status-pending" id="storyStatus">Pending</div>
                        </div>
                        <div id="storyResults" class="results-section" style="display: none;"></div>
                    </div>

                    <div class="status-card" id="collaborativeCard">
                        <div class="phase-header">
                            <div class="phase-icon collaborative">4</div>
                            <div class="phase-title">Collaborative Refinement</div>
                            <div class="phase-status status-pending" id="collaborativeStatus">Pending</div>
                        </div>
                        <div id="collaborativeResults" class="results-section" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div id="errorSection" style="display: none;"></div>

            <div class="campaigns-list">
                <h2 onclick="toggleCampaignsList()" style="font-size: 1.4rem; background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb;">
                    Recent Campaigns
                    <span id="campaignsToggle" class="campaigns-toggle">▼</span>
                </h2>
                <div id="campaignsList" class="campaigns-content"></div>
            </div>
        </div>
    </div>

    <!-- Deliverables Side Panel -->
    <div class="panel-overlay" id="panelOverlay" onclick="closePanelsOnMobile()"></div>
    <div class="deliverables-panel" id="deliverablesPanel">
        <div class="deliverables-header">
            <h3>
                Campaign Deliverables
            </h3>
        </div>
        <div class="deliverables-content" id="deliverablesContent">
            <p style="color: #666; text-align: center; margin-top: 50px;">No deliverables available yet. Start a campaign to see deliverables here.</p>
        </div>
    </div>

    <!-- Progress Side Panel -->
    <div class="progress-panel" id="progressPanel">
        <div class="panel-header">
            <h3>
                🔄 Campaign Progress
                <button class="close-panel" onclick="closeProgressPanel()">×</button>
            </h3>
        </div>
        <div class="progress-content" id="progressPanelContent">
            <div class="progress-messages" id="progressPanelMessages">
                <p style="color: #666; text-align: center; margin-top: 50px; font-size: 0.85rem;">No progress updates yet. Start a campaign to see real-time progress here.</p>
            </div>
        </div>
    </div>

    <script>
        let currentCampaignId = null;
        let pollingInterval = null;
        let campaignDeliverables = {};
        let progressMessages = [];
        let lastProgressCount = 0;
        let isCreatingCampaign = false; // Prevent duplicate submissions
        let currentPhase = null; // Track current phase
        let phaseStartTime = null; // Track phase timing

        async function createCampaign() {
            // Prevent multiple submissions
            if (isCreatingCampaign) {
                console.log('Campaign creation already in progress, ignoring duplicate request');
                return;
            }

            // Clear previous campaign deliverables
            campaignDeliverables = {};
            if (document.getElementById('deliverablesContent')) {
                updateDeliverablesPanel();
            }

            const brief = document.getElementById('campaignBrief').value.trim();
            
            if (!brief) {
                alert('Please enter a campaign brief');
                return;
            }

            // Set flag to prevent duplicates
            isCreatingCampaign = true;
            
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'Creating Campaign...';

            // Reset progress and phase tracking
            progressMessages = [];
            lastProgressCount = 0;
            currentPhase = null;
            phaseStartTime = new Date();
            document.getElementById('progressUpdates').style.display = 'none'; // Hide center progress
            document.getElementById('progressBtn').style.display = 'inline-block'; // Show progress button
            document.getElementById('progressPanelMessages').innerHTML = ''; // Clear side panel
            addProgressMessage('🚀 Initializing campaign creation...', 'info');
            addProgressMessage('📝 Processing campaign brief and requirements', 'info');

            try {
                const response = await fetch('/api/campaigns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ campaignBrief: brief })
                });

                const result = await response.json();

                if (response.ok) {
                    // The result contains campaignId, not id
                    currentCampaignId = result.campaignId;
                    document.getElementById('campaignId').innerHTML = `
                        <div class="campaign-id">Campaign ID: ${currentCampaignId}</div>
                        <div class="campaign-status status-active">Active</div>
                    `;
                    document.getElementById('statusSection').style.display = 'block';
                    
                    addProgressMessage('✅ Campaign created successfully', 'success');
                    addProgressMessage('🤖 AI agents are now collaborating on your campaign', 'info');
                    addProgressMessage('⏱️ Estimated completion time: 2-3 minutes', 'info');
                    
                    // Show conversation flow immediately with initial data
                    updateConversationFlow(result);
                    
                    // Start polling for updates immediately
                    startPolling();
                    
                    // Also do an immediate poll
                    setTimeout(updateCampaignStatus, 2000); // Increased delay
                    
                    // Clear the form after successful creation and conversation display
                    setTimeout(() => {
                        document.getElementById('campaignBrief').value = '';
                    }, 1000); // Delay clearing to ensure conversation is displayed
                } else {
                    showError(result.error || 'Failed to create campaign');
                    addProgressMessage('❌ Campaign creation failed', 'error');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
                addProgressMessage('❌ Network error occurred', 'error');
            } finally {
                // Reset flag and button state
                isCreatingCampaign = false;
                createBtn.disabled = false;
                createBtn.textContent = 'Create Campaign';
            }
        }

        function trackPhaseChange(newPhase) {
            if (currentPhase !== newPhase) {
                if (currentPhase && phaseStartTime) {
                    const duration = Math.round((new Date() - phaseStartTime) / 1000);
                    addProgressMessage(`⏱️ ${currentPhase} phase completed in ${duration}s`, 'info', `${currentPhase}-timing`);
                }
                currentPhase = newPhase;
                phaseStartTime = new Date();
                
                // Add phase-specific timing estimates
                const estimates = {
                    'Research': '30-45 seconds',
                    'Strategic Insight': '20-30 seconds', 
                    'Trending': '25-35 seconds',
                    'Story': '30-40 seconds',
                    'Collaborative': '40-60 seconds'
                };
                
                if (estimates[newPhase]) {
                    addProgressMessage(`⏳ ${newPhase} phase starting (est. ${estimates[newPhase]})`, 'info', `${newPhase}-estimate`);
                }
            }
        }

        function simulateProgressFromConversation(campaign) {
            if (!campaign.conversation) return;
            
            // Only add new messages since last check
            const newMessages = campaign.conversation.slice(lastProgressCount);
            
            newMessages.forEach((message, index) => {
                const speaker = message.speaker;
                const timestamp = new Date(message.timestamp).toLocaleTimeString();
                
                // Avoid duplicate progress messages by checking if we already logged this message
                const messageKey = `${speaker}-${message.timestamp}`;
                if (progressMessages.some(p => p.key === messageKey)) {
                    return; // Skip if already processed
                }
                
                // More detailed progress tracking based on actual conversation flow
                if (speaker === 'Campaign Brief') {
                    addProgressMessage(`📝 Original campaign brief recorded: "${message.message.substring(0, 50)}..."`, 'info', messageKey);
                } else if (speaker === 'PR Manager') {
                    if (message.message.includes('campaign introduction') || index === 0) {
                        addProgressMessage(`👔 Campaign initiated - PR Manager setting strategic direction`, 'phase', messageKey);
                    } else if (message.message.includes('research') || message.message.includes('Research')) {
                        trackPhaseChange('Research');
                        addProgressMessage(`🔄 Transitioning to Research & Audience Analysis phase`, 'info', messageKey);
                    } else if (message.message.includes('trending') || message.message.includes('trends')) {
                        trackPhaseChange('Trending');
                        addProgressMessage(`🔄 Transitioning to Trending News Analysis phase`, 'info', messageKey);
                    } else if (message.message.includes('story') || message.message.includes('Story')) {
                        trackPhaseChange('Story');
                        addProgressMessage(`🔄 Transitioning to Story Development phase`, 'info', messageKey);
                    } else if (message.message.includes('collaborative') || message.message.includes('final')) {
                        trackPhaseChange('Collaborative');
                        addProgressMessage(`🔄 Transitioning to Collaborative Synthesis phase`, 'info', messageKey);
                    } else {
                        addProgressMessage(`👔 PR Manager: ${message.message.substring(0, 60)}...`, 'phase', messageKey);
                    }
                } else if (speaker.includes('Research')) {
                    trackPhaseChange('Research');
                    addProgressMessage(`🔍 Research Agent: Analyzing target audience and market insights`, 'info', messageKey);
                } else if (speaker.includes('Strategic Insight')) {
                    trackPhaseChange('Strategic Insight');
                    addProgressMessage(`🧠 Strategic Insight Agent: Converting insights to emotional truths`, 'info', messageKey);
                } else if (speaker.includes('Trending')) {
                    trackPhaseChange('Trending');
                    addProgressMessage(`📈 Trending Agent: Analyzing current market trends and cultural moments`, 'info', messageKey);
                } else if (speaker.includes('Story')) {
                    trackPhaseChange('Story');
                    addProgressMessage(`✍️ Story Agent: Developing compelling narratives and headlines`, 'info', messageKey);
                } else if (speaker === 'All Agents') {
                    trackPhaseChange('Collaborative');
                    addProgressMessage(`🤝 Collaborative Phase: All agents synthesizing final strategy`, 'phase', messageKey);
                }
                
                // Enhanced deliverable tracking
                if (message.deliverable) {
                    const deliverableType = getDeliverableType(message.deliverable);
                    const speakerIcon = getSpeakerIcon(speaker);
                    addProgressMessage(`${speakerIcon} ${deliverableType} deliverable completed by ${speaker}`, 'success', `${messageKey}-deliverable`);
                    
                    // Show quality metrics if available
                    if (message.qualityScore !== undefined) {
                        const qualityLevel = message.qualityScore > 0 ? 'high' : 'needs improvement';
                        addProgressMessage(`📊 Quality assessment: ${qualityLevel} confidence`, 'warning', `${messageKey}-quality`);
                    }
                }
            });
            
            lastProgressCount = campaign.conversation.length;
            
            // Enhanced completion tracking
            if (campaign.status === 'completed' && !progressMessages.some(m => m.message.includes('Campaign completed'))) {
                addProgressMessage('🎉 Campaign strategy completed successfully!', 'success', 'completion');
                addProgressMessage('💾 Campaign saved and ready for implementation', 'success', 'saved');
            }
        }

        function getDeliverableType(deliverable) {
            if (typeof deliverable === 'object') {
                if (deliverable.analysis) return 'Audience Research';
                if (deliverable.humanTruthAnalysis) return 'Strategic Insight';
                if (deliverable.trendsAnalysis) return 'Trends Analysis';
                if (deliverable.storyStrategy) return 'Story Strategy';
                if (deliverable.theme || deliverable.humanTruth) return 'Integrated Campaign Plan';
            }
            return 'Strategy';
        }

        function addProgressMessage(message, type = 'info', key = null) {
            const timestamp = new Date().toLocaleTimeString();
            const messageObj = { 
                message, 
                type, 
                timestamp, 
                key: key || `${timestamp}-${message.substring(0, 20)}` 
            };
            
            // Check for duplicates by finding the index of an existing message with the same key
            const existingMessageIndex = progressMessages.findIndex(p => p.key === messageObj.key);

            if (existingMessageIndex > -1) {
                // Replace existing message to update timestamp/content
                progressMessages[existingMessageIndex] = messageObj;
                console.log(`[Progress Debug] Updated existing message with key: "${messageObj.key}"`);
            } else {
                // Add new message
                progressMessages.push(messageObj);
                console.log(`[Progress Debug] Added new message with key: "${messageObj.key}"`);
            }
            
            // Re-render the entire progress panel to reflect changes
            renderProgressPanel();
            
            // Show progress button if not already visible
            document.getElementById('progressBtn').style.display = 'inline-block';
        }

        function renderProgressPanel() {
            const progressContainer = document.getElementById('progressPanelMessages');
            if (!progressContainer) return;

            // Check if user is scrolled to the bottom before clearing and re-rendering
            const scrollThreshold = 5; 
            const userWasAtBottom = progressContainer.scrollHeight - progressContainer.clientHeight <= progressContainer.scrollTop + scrollThreshold;

            progressContainer.innerHTML = ''; // Clear existing messages

            if (progressMessages.length === 0) {
                progressContainer.innerHTML = '<p style="color: #666; text-align: center; margin-top: 50px; font-size: 0.85rem;">No progress updates yet. Start a campaign to see real-time progress here.</p>';
            } else {
                progressMessages.forEach(msgObj => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `progress-message ${msgObj.type}`;
                    messageDiv.innerHTML = `<span class="progress-timestamp">${msgObj.timestamp}</span>${msgObj.message}`;
                    progressContainer.appendChild(messageDiv);
                });
            }

            if (userWasAtBottom) {
                progressContainer.scrollTop = progressContainer.scrollHeight;
            }
        }

        function formatMarkdown(text) {
            if (!text) return '';
            
            // Convert markdown to HTML
            return text
                // ADDED: First, replace literal '\\n' with actual newlines '\n'
                .replace(/\\n/g, '\n')

                // Headers
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^\*\*(.*)\*\*$/gm, '<h4>$1</h4>')
                
                // Bold and italic
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                
                // Lists
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/^(\d+)\. (.*$)/gm, '<li>$2</li>')
                
                // Line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                
                // Wrap in paragraphs
                .replace(/^(?!<[h|l|p])/gm, '<p>')
                .replace(/(?<!>)$/gm, '</p>')
                
                // Clean up empty paragraphs
                .replace(/<p><\/p>/g, '')
                .replace(/<p><br><\/p>/g, '')
                
                // Wrap lists
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/<\/ul>\s*<ul>/g, '');
        }

        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            
            // Reduced polling frequency to prevent overwhelming the server
            pollingInterval = setInterval(async () => {
                if (currentCampaignId && !isCreatingCampaign) {
                    await updateCampaignStatus();
                }
            }, 3000); // Increased from 1000ms to 3000ms
        }

        async function updateCampaignStatus() {
            try {
                console.log(`Polling campaign status for: ${currentCampaignId}`);
                const response = await fetch(`/api/campaigns/${currentCampaignId}`);
                const campaign = await response.json();

                console.log('Campaign status response:', campaign);

                if (response.ok) {
                    updateConversationFlow(campaign);
                    simulateProgressFromConversation(campaign);

                    if (campaign.status === 'completed') {
                        clearInterval(pollingInterval);
                    }
                } else {
                    console.error('Failed to fetch campaign status:', campaign.error);
                }
            } catch (error) {
                console.error('Error polling campaign status:', error);
            }
        }

        function updateConversationFlow(campaign) {
            const conversationMessages = document.getElementById('conversationMessages');
            const newMessagesBtn = document.getElementById('newMessagesIndicator');
            
            if (!campaign.conversation) {
                conversationMessages.innerHTML = '<p>No conversation data available</p>';
                if (newMessagesBtn) newMessagesBtn.style.display = 'none';
                return;
            }

            // Check if user is scrolled to the bottom BEFORE adding new messages
            const scrollThreshold = 10;
            const userWasAtBottom = conversationMessages.scrollHeight - conversationMessages.clientHeight <= conversationMessages.scrollTop + scrollThreshold;

            // Determine if there are actually new messages being added compared to what's currently rendered
            const currentMessageCount = conversationMessages.children.length;
            const newMessageCount = campaign.conversation.length;
            const hasNewMessages = newMessageCount > currentMessageCount;

            conversationMessages.innerHTML = campaign.conversation.map(message => {
                const speakerClass = getSpeakerClass(message.speaker);
                const speakerIcon = getSpeakerIcon(message.speaker);
                const isProcessing = message.isProcessing ? 'processing' : '';
                
                let messageHtml = `
                    <div class="conversation-message ${speakerClass} ${isProcessing}">
                        <div class="message-speaker">${speakerIcon} ${message.speaker}:</div>
                        <div class="message-content">${message.message}</div>
                        <div class="message-timestamp">${new Date(message.timestamp).toLocaleTimeString()}</div>
                    </div>
                `;

                if (message.deliverable) {
                    messageHtml += `
                        <div class="deliverable-section">
                            ${formatDeliverableData(message.deliverable, message.agent || message.speaker)}
                        </div>
                    `;
                }

                return messageHtml;
            }).join('');

            if (userWasAtBottom) {
                conversationMessages.scrollTop = conversationMessages.scrollHeight;
                if (newMessagesBtn) newMessagesBtn.style.display = 'none';
            } else {
                if (hasNewMessages && newMessagesBtn) {
                    newMessagesBtn.style.display = 'block';
                }
            }
        }

        function scrollToConversationBottom() {
            const conversationMessages = document.getElementById('conversationMessages');
            const newMessagesBtn = document.getElementById('newMessagesIndicator');
            if (conversationMessages) {
                conversationMessages.scrollTop = conversationMessages.scrollHeight;
            }
            if (newMessagesBtn) {
                newMessagesBtn.style.display = 'none';
            }
        }

        function getSpeakerClass(speaker) {
            switch (speaker) {
                case 'Campaign Brief':
                    return 'campaign-brief';
                case 'PR Manager':
                    return 'pr-manager';
                case 'Research & Audience GPT':
                    return 'research-agent';
                case 'Strategic Insight GPT':
                    return 'strategic-agent';
                case 'Trending News GPT':
                    return 'trending-agent';
                case 'Story Angles & Headlines GPT':
                    return 'story-agent';
                case 'All Agents':
                    return 'all-agents';
                default:
                    return '';
            }
        }

        function getSpeakerIcon(speaker) {
            switch (speaker) {
                case 'Campaign Brief':
                    return '📝';
                case 'PR Manager':
                    return '👔';
                case 'Research & Audience GPT':
                    return '🔍';
                case 'Strategic Insight GPT':
                    return '🧠';
                case 'Trending News GPT':
                    return '📈';
                case 'Story Angles & Headlines GPT':
                    return '✍️';
                case 'All Agents':
                    return '🤝';
                default:
                    return '🤖';
            }
        }

        function formatDeliverableData(deliverable, agent) {
            if (typeof deliverable === 'object') {
                let content = '';
                let title = `${agent} Deliverable`;

                // Handle Research & Audience deliverables
                if (deliverable.analysis) {
                    title = "Audience Research & Insights";
                    content = deliverable.analysis;
                } 
                // Handle Trending News deliverables
                else if (deliverable.trendsAnalysis) {
                    title = "Trending News Analysis";
                    content = deliverable.trendsAnalysis;
                } 
                // Handle Story Angles deliverables
                else if (deliverable.storyStrategy) {
                    title = "Story Angles & Headlines";
                    content = deliverable.storyStrategy;
                }
                // Handle Strategic Insight deliverables
                else if (deliverable.humanTruthAnalysis) {
                    title = "Strategic Insight & Human Truth";
                    content = deliverable.humanTruthAnalysis;
                }
                // Handle comprehensive final strategy deliverables
                else if (deliverable.theme || deliverable.humanTruth || deliverable.storyAngles || deliverable.trends) {
                    title = "Integrated Campaign Plan";
                    content = ''; // Initialize content

                    if (deliverable.theme) {
                        content += `CAMPAIGN THEME\\n${deliverable.theme}\\n\\n`;
                    }

                    if (deliverable.humanTruth) {
                        content += `HUMAN TRUTH\\n${deliverable.humanTruth}\\n\\n`;
                    }

                    // For storyAngles
                    if (deliverable.storyAngles) {
                        content += 'STORY STRATEGY\\n';
                        if (typeof deliverable.storyAngles === 'string') {
                            content += `${deliverable.storyAngles}\\n\\n`;
                        } else if (typeof deliverable.storyAngles === 'object') {
                            // If the object has a 'storyStrategy' property, use it
                            if (deliverable.storyAngles.storyStrategy && typeof deliverable.storyAngles.storyStrategy === 'string') {
                                content += `${deliverable.storyAngles.storyStrategy}\\n\\n`;
                            }
                            // If it has an 'angles' property (as seen in backend story.angles)
                            else if (deliverable.storyAngles.angles && typeof deliverable.storyAngles.angles === 'string') {
                                content += `${deliverable.storyAngles.angles}\\n\\n`;
                            }
                            // Fallback: stringify the object, assuming it contains the details directly
                            else {
                                content += `${JSON.stringify(deliverable.storyAngles, null, 2)}\\n\\n`;
                            }
                        }
                    }

                    // For trends
                    if (deliverable.trends) {
                        content += 'TRENDS ANALYSIS\\n';
                        if (typeof deliverable.trends === 'string') {
                            content += `${deliverable.trends}\\n\\n`;
                        } else if (Array.isArray(deliverable.trends)) {
                            // If it's an array of strings or simple objects
                            content += deliverable.trends.map(trend => {
                                if (typeof trend === 'string') return `- ${trend}`;
                                if (typeof trend === 'object' && trend.trendName) return `- ${trend.trendName}: ${trend.description || ''}`; // Example structure
                                return `- ${JSON.stringify(trend)}`;
                            }).join('\\n') + '\\n\\n';
                        } else if (typeof deliverable.trends === 'object') {
                            // If the object has a 'trendsAnalysis' property, use it
                            if (deliverable.trends.trendsAnalysis && typeof deliverable.trends.trendsAnalysis === 'string') {
                                content += `${deliverable.trends.trendsAnalysis}\\n\\n`;
                            }
                            // Fallback: stringify the object
                            else {
                                content += `${JSON.stringify(deliverable.trends, null, 2)}\\n\\n`;
                            }
                        }
                    }

                    // If no structured content was found, show what we have
                    if (!content) {
                        content = 'Comprehensive campaign strategy has been generated. Please check the deliverables panel for full details.';
                    }
                }
                // Fallback for any other object structure
                else {
                    // Try to extract any meaningful content from the object
                    const keys = Object.keys(deliverable);
                    if (keys.length > 0) {
                        content = keys.map(key => {
                            const value = deliverable[key];
                            if (typeof value === 'string' && value.length > 50) {
                                return `${key.toUpperCase()}\n${value}\n`;
                            } else if (typeof value === 'object') {
                                return `${key.toUpperCase()}\n${JSON.stringify(value, null, 2)}\n`;
                            }
                            return `${key}: ${value}`;
                        }).join('\n');
                    } else {
                        content = 'Deliverable content is available but in an unexpected format.';
                    }
                }

                const existingDeliverable = campaignDeliverables[agent];
                campaignDeliverables[agent] = { 
                    title, 
                    content,
                    // Preserve existing expanded state, or default for new deliverables
                    expanded: existingDeliverable ? existingDeliverable.expanded : (Object.keys(campaignDeliverables).length === 0)
                };
                
                // Show deliverables button and auto-update panel
                document.getElementById('deliverablesBtn').style.display = 'inline-block';
                
                // Auto-update deliverables panel if it exists
                if (document.getElementById('deliverablesContent')) {
                    updateDeliverablesPanel();
                }
                
                // Add visual notification for new deliverable
                addDeliverableNotification(title);

                return `<div class="deliverable-placeholder">
                    📄 <strong>DELIVERABLE:</strong> ${title}
                    <span class="deliverable-badge">Ready</span>
                    <button class="deliverable-toggle" onclick="openDeliverablesPanel()">View Details</button>
                </div>`;
            }

            // Handle string deliverables
            campaignDeliverables[agent] = { 
                title: `${agent} Deliverable`, 
                content: deliverable,
                expanded: Object.keys(campaignDeliverables).length === 0 // First deliverable is expanded
            };
            document.getElementById('deliverablesBtn').style.display = 'inline-block';
            
            // Auto-update deliverables panel if it exists
            if (document.getElementById('deliverablesContent')) {
                updateDeliverablesPanel();
            }
            
            // Add visual notification for new deliverable
            addDeliverableNotification(`${agent} Deliverable`);

            return `<div class="deliverable-placeholder">
                📄 <strong>DELIVERABLE:</strong> ${agent} Deliverable
                <span class="deliverable-badge">Ready</span>
                <button class="deliverable-toggle" onclick="openDeliverablesPanel()">View Details</button>
            </div>`;
        }

        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.innerHTML = `<div class="error">${message}</div>`;
            errorSection.style.display = 'block';
            
            setTimeout(() => {
                errorSection.style.display = 'none';
            }, 5000);
        }

        // Load recent campaigns on page load
        async function loadRecentCampaigns() {
            try {
                console.log('🔄 Loading recent campaigns...');
                const response = await fetch('/api/campaigns');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const campaigns = await response.json();
                console.log(`📚 Loaded ${campaigns.length} campaigns`);
                
                const campaignsList = document.getElementById('campaignsList');
                
                if (campaigns.length === 0) {
                    campaignsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No campaigns yet. Create your first campaign above!</p>';
                    return;
                }
                
                // Reverse the order to show most recent first
                const sortedCampaigns = campaigns.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                campaignsList.innerHTML = sortedCampaigns.map(campaign => `
                    <div class="campaign-item" onclick="loadCampaign('${campaign.id}')">
                        <div class="campaign-meta">
                            <span class="campaign-id">${campaign.id}</span>
                            <span class="campaign-status status-${campaign.status}">${campaign.status}</span>
                        </div>
                        <p>${campaign.brief}</p>
                        <small>Created: ${new Date(campaign.createdAt).toLocaleString()}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('❌ Failed to load campaigns:', error);
                const campaignsList = document.getElementById('campaignsList');
                campaignsList.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 20px;">Failed to load campaigns. Please refresh the page.</p>';
            }
        }

        function loadCampaign(campaignId) {
            currentCampaignId = campaignId;
            
            // Reset all tracking variables
            progressMessages = [];
            lastProgressCount = 0;
            isCreatingCampaign = false; // Reset the creation flag
            
            // Clear previous campaign deliverables
            campaignDeliverables = {};
            if (document.getElementById('deliverablesContent')) {
                updateDeliverablesPanel();
            }
            
            document.getElementById('progressMessages').innerHTML = '';
            document.getElementById('progressPanelMessages').innerHTML = '';
            document.getElementById('progressUpdates').style.display = 'none';
            document.getElementById('progressBtn').style.display = 'inline-block';
            addProgressMessage('🔄 Loading existing campaign...', 'info', 'loading-start');
            
            document.getElementById('campaignId').innerHTML = `
                <div class="campaign-id">Campaign ID: ${campaignId}</div>
                <div class="campaign-status status-active">Loading...</div>
            `;
            document.getElementById('statusSection').style.display = 'block';
            
            // Reset deliverables button
            document.getElementById('deliverablesBtn').style.display = 'none';
            document.getElementById('deliverablesBtn').innerHTML = 'View Deliverables';
            
            // Reset all phases
            ['research', 'trending', 'story', 'collaborative'].forEach(phase => {
                const card = document.getElementById(`${phase}Card`);
                const status = document.getElementById(`${phase}Status`);
                const results = document.getElementById(`${phase}Results`);
                
                if (card && status && results) {
                    card.className = 'status-card';
                    status.textContent = 'Pending';
                    status.className = 'phase-status status-pending';
                    results.style.display = 'none';
                }
            });
            
            startPolling();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadRecentCampaigns();
            updateContainerClasses();
            if (document.getElementById('deliverablesContent')) {
                updateDeliverablesPanel();
            }
            // ADDED: Initial render of the progress panel if it exists, to show placeholder or existing messages
            if (document.getElementById('progressPanelMessages')) {
                renderProgressPanel();
            }

            // ADDED: Event listener for conversation scroll
            const conversationMessages = document.getElementById('conversationMessages');
            if (conversationMessages) {
                conversationMessages.addEventListener('scroll', () => {
                    const newMessagesBtn = document.getElementById('newMessagesIndicator');
                    if (newMessagesBtn && newMessagesBtn.style.display === 'block') {
                        // If user scrolls to the bottom manually, hide the button
                        const scrollThreshold = 10;
                        if (conversationMessages.scrollHeight - conversationMessages.clientHeight <= conversationMessages.scrollTop + scrollThreshold) {
                            newMessagesBtn.style.display = 'none';
                        }
                    }
                });
            }
        });

        // Progress Panel Functions - LEFT SIDE
        function openProgressPanel() {
            document.getElementById('progressPanel').classList.add('open');
            updateContainerClasses();
        }

        function closeProgressPanel() {
            document.getElementById('progressPanel').classList.remove('open');
            updateContainerClasses();
        }

        // Deliverables Panel Functions - RIGHT SIDE
        function openDeliverablesPanel() {
            updateContainerClasses();
            updateDeliverablesPanel();
        }

        // Update container classes based on panel states
        function updateContainerClasses() {
            const container = document.querySelector('.container');
            const progressPanel = document.getElementById('progressPanel');

            container.classList.remove('progress-open', 'deliverables-open', 'both-open');

            if (progressPanel.classList.contains('open')) {
                container.classList.add('both-open');
            } else {
                container.classList.add('deliverables-open');
            }
            
            // Handle overlay for mobile (progress panel only now)
            const isMobile = window.innerWidth <= 768;
            if (isMobile && progressPanel.classList.contains('open')) {
                document.getElementById('panelOverlay').classList.add('show');
            } else {
                document.getElementById('panelOverlay').classList.remove('show');
            }
        }

        // Close all panels (now only effectively closes progress panel if mobile overlay is clicked)
        function closePanels() {
            document.getElementById('progressPanel').classList.remove('open');
            updateContainerClasses();
        }

        function updateDeliverablesPanel() {
            const content = document.getElementById('deliverablesContent');
            
            if (Object.keys(campaignDeliverables).length === 0) {
                content.innerHTML = '<p style="color: #666; text-align: center; margin-top: 50px;">No deliverables available yet.</p>';
                return;
            }

            let html = '';
            for (const [agentName, deliverable] of Object.entries(campaignDeliverables)) {
                const formattedContent = formatMarkdown(deliverable.content || 'No content available');
                const agentIcon = getSpeakerIcon(agentName);
                html += `
                    <div class="deliverable-item">
                        <div class="deliverable-header ${deliverable.expanded ? 'expanded' : ''}" onclick="toggleDeliverable('${agentName}')">
                            <div>
                                <h4>${deliverable.title || agentName}</h4>
                                <div class="agent-name">${agentIcon} From: ${agentName}</div>
                            </div>
                            <div class="deliverable-actions">
                                <button class="download-btn" onclick="downloadDeliverable('${agentName}', event)" title="Download as markdown file">
                                    📥
                                </button>
                                <span class="collapse-icon ${deliverable.expanded ? 'expanded' : ''}">▼</span>
                            </div>
                        </div>
                        <div class="deliverable-content ${deliverable.expanded ? 'expanded' : ''}">${formattedContent}</div>
                    </div>
                `;
            }
            content.innerHTML = html;
        }

        function toggleDeliverable(agentName) {
            const deliverable = campaignDeliverables[agentName];
            deliverable.expanded = !deliverable.expanded;
            updateDeliverablesPanel();
        }

        function closePanelsOnMobile() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                closePanels();
            }
        }

        function addDeliverableNotification(title) {
            // Update deliverables button with count
            const deliverableCount = Object.keys(campaignDeliverables).length;
            const deliverablesBtn = document.getElementById('deliverablesBtn');
            
            // Add count badge to button
            deliverablesBtn.innerHTML = `View Deliverables <span style="background: #dc3545; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; margin-left: 5px;">${deliverableCount}</span>`;
            
            // Add progress message about new deliverable
            addProgressMessage(`📄 New deliverable available: ${title}`, 'success', `deliverable-${currentCampaignId}-${title}`);
            
            // Briefly highlight the deliverables button
            deliverablesBtn.style.animation = 'pulse 2s ease-in-out';
            setTimeout(() => {
                deliverablesBtn.style.animation = '';
            }, 2000);
        }

        function toggleCampaignsList() {
            const campaignsList = document.getElementById('campaignsList');
            const toggleIcon = document.getElementById('campaignsToggle');
            
            if (campaignsList.classList.contains('open')) {
                campaignsList.classList.remove('open');
                toggleIcon.style.transform = 'rotate(0deg)';
            } else {
                campaignsList.classList.add('open');
                toggleIcon.style.transform = 'rotate(180deg)';
            }
        }

        function downloadDeliverable(agentName, event) {
            event.preventDefault();
            event.stopPropagation(); // Prevent triggering the collapse/expand
            
            const deliverable = campaignDeliverables[agentName];
            if (!deliverable || !deliverable.content) {
                alert('No content available to download');
                return;
            }
            
            const content = deliverable.content;
            // Create a clean filename
            const cleanAgentName = agentName.replace(/[^a-zA-Z0-9]/g, '_');
            const timestamp = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            const filename = `${cleanAgentName}_deliverable_${timestamp}.md`;

            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 